<!doctype html>
<meta charset="utf-8">
<title>Junior's To-Do List</title>
<script src="todoDemoBundle.js"></script>

<style>
  html {
    background-color: #f5f5f5;
  }

  .title {
    color: #ead7d7;
  }

  .panel-block {
    background-color: white;
  }

  .todos {
    width: 500px;
    margin: 50px auto;
    text-align: center;
  }

  .newTodoInput::placeholder {
    font-style: italic;
  }

  .todoList {
    max-height: 320px;
    overflow: auto;
  }

  .todoToggleBtn {
    min-width: 64px;
    margin-right: 10px;
  }

  .done {
    text-decoration: line-through;
  }
</style>

<div class="todos">
  <h1 class="title is-1">Junior's To-Do List</h1>

  <div class="panel box" jr-style="
    padding: 10px;

    background-color: ${
      activeTodos.length ? 'antiquewhite' : 'aliceblue'
    };
  ">
    <div class="panel-block" style="margin-bottom: -1px">
      <input
        class="newTodoInput input"
        placeholder="What needs to be done?"
        jr-value.bind="newTodoDescription"
      >
    </div>

    <div class="todoList" jr-list="for todo of filteredTodos">
      <a jr-class="todoBlock panel-block ${
        todo.done ? 'is-active' : ''
      }">
        <button
          jr-class="todoToggleBtn button ${
            !todo.done ? 'is-success' : 'is-danger'
          }"

          jr-textcontent.bind="!todo.done ? 'Done' : 'Undo'"
        ></button>

        <input
          jr-if="todo.editing"
          class="editTodoInput input"
          jr-value.bind="todo.description"
        >

        <span
          jr-if="!todo.editing"
          jr-class="${todo.done ? 'done' : ''}"
          jr-textcontent.bind="todo.description"
        ></span>
      </a>
    </div>

    <div class="panel-block" style="flex-flow: column">
      <div class="field has-addons">
        <span class="control">
          <button
            jr-class="allFilterBtn button is-small ${
              filter === 'all' ? 'is-info' : ''
            }"

            jr-textcontent="All (${todos.length})"
          ></button>
        </span>

        <span class="control">
          <button
            jr-class="activeFilterBtn button is-small ${
              filter === 'active' ? 'is-info' : ''
            }"

            jr-textcontent="Active (${activeTodos.length})"
          ></button>
        </span>

        <span class="control">
          <button
            jr-class="completedFilterBtn button is-small ${
              filter === 'completed' ? 'is-info' : ''
            }"

            jr-textcontent="Completed (${completedTodos.length})"
          ></button>
        </span>
      </div>
    </div>
  </div>
</div>

<script>
  let root = jr.findFirst('.todos');

  window.rootScope = root.jr.setScope({
    newTodoDescription: '',

    todos: [
      { description: `Keep everything refreshingly simple`, done: true },
      { description: `Inflict jQuery nostalgia on people`, done: true },
      { description: `Maybe port and run some benchmarks to Junior?`, done: false },
      { description: `Optimize strictly as needed`, done: false },
      { description: `Destroy React, Vue, Angular, etc.`, done: false },
      { description: `Spare Mithril because it's cute`, done: false },
    ],

    get activeTodos() {
      return this.todos.filter(x => !x.done);
    },

    get completedTodos() {
      return this.todos.filter(x => x.done);
    },

    filter: 'all',

    get filteredTodos() {
      switch (this.filter) {
        case 'all':
          return this.todos;

        case 'active':
          return this.activeTodos;

        case 'completed':
          return this.completedTodos;
      }
    },
  });

  root.addEventListener('keydown', ev => {
    if (!ev.target.classList.contains('newTodoInput')) {
      return;
    }

    if (ev.key !== 'Enter') {
      return;
    }

    let scope = jr(ev.target).jr.getScope();

    scope.hash.todos.push({
      description: scope.hash.newTodoDescription,
      done: false,
    });

    scope.set('newTodoDescription', '');
    jr.update();

    jr.findFirst('.todoList').scrollTop = 999999999;
  });

  root.addEventListener('click', ev => {
    if (ev.target.classList.contains('todoToggleBtn')) {
      let { todo } = jr(ev.target).jr.getScope().hash;
      todo.done = !todo.done;

      return;
    }

    if (ev.target.classList.contains('allFilterBtn')) {
      rootScope.filter = 'all';
      return;
    }

    if (ev.target.classList.contains('activeFilterBtn')) {
      rootScope.filter =
        rootScope.filter === 'active'
        ? 'all' : 'active';

      return;
    }

    if (ev.target.classList.contains('completedFilterBtn')) {
      rootScope.filter =
        rootScope.filter === 'completed'
        ? 'all' : 'completed';

      return;
    }

    let { parentElements } = jr(ev.target).jr;

    for (let el of [ev.target, ...parentElements]) {
      if (el.classList.contains('todoBlock')) {
        let { todos, todo } =
          jr(ev.target).jr.getScope().hash;

        todo.editing = true;

        let doneEditing = () => {
          if (!todo.editing) {
            return;
          }

          todo.editing = false;

          if (!todo.description) {
            todos.splice(todos.indexOf(todo), 1);
          }

          jr.update();
        };

        requestAnimationFrame(() => {
          let input = jr.findFirst('.editTodoInput');

          input.addEventListener('blur', doneEditing);

          input.addEventListener('keydown', ev => {
            if (ev.key === 'Enter') {
              doneEditing();
            }
          });

          input.select();
        });

        return;
      }
    }
  });

  root.addEventListener('blur', ev => {
    if (ev.target.classList.contains('editTodoInput')) {
      let { todo } = jr(ev.target).jr.getScope().hash;

      todo.editing = false;
      jr.update();

      return;
    }
  });

  jr.init();
</script>
